
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Elastix example in Matlab</title><meta name="generator" content="MATLAB 9.2"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-07-28"><meta name="DC.source" content="elxExampleElastix.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Elastix example in Matlab</h1><!--introduction--><p>This Matlab script shows how to reproduce with ElastixFromMatlab the Elastix example provided with the source code. Before running that script, you must</p><div><ul><li>understand Elastix</li><li>be familiar with the Elastix example</li><li>be familiar with Matlab</li><li>have installed elastix on your computer and have successfully run the function <a href="elxTestDefaultConfiguration.html"><tt>elxTestDefaultConfiguration</tt></a>.</li></ul></div><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Load the ElastixFromMatlab configuration</a></li><li><a href="#3">Test elastix version</a></li><li><a href="#4">Test myConf.ExampleInputDirectory</a></li><li><a href="#5">Load the fixed and moving image into Matlab</a></li><li><a href="#7">Show the fixed and moving images</a></li><li><a href="#10">Configure the Euler transform</a></li><li><a href="#12">Configure the BSpline transform</a></li><li><a href="#13">Run Elastix</a></li><li><a href="#15">Display the registered images and the metrics at each resolution</a></li><li><a href="#18">Compare with the expected result</a></li><li><a href="#19">What about the <tt>Log</tt> structure?</a></li><li><a href="#20">Elastix and masks</a></li><li><a href="#21">Apply the deformation to the moving mask and compute the determinant of the jacobian</a></li><li><a href="#24">License</a></li></ul></div><h2 id="1">Load the ElastixFromMatlab configuration</h2><pre class="codeinput">myConf = elxDefaultConfiguration;
</pre><p>Feel free to adjust the settings in</p><div><ul><li><a href="elxDefaultConfiguration.html"><tt>elxDefaultConfiguration</tt></a> which is the system wide default configuration file</li><li>elxUserDefaultConfiguraiont which is the user default configuration file (If this last function exists and is in your path, it is called by <a href="elxDefaultConfiguration.html"><tt>elxDefaultConfiguration</tt></a>).</li></ul></div><p>In those files, you may adjust:</p><div><ul><li>StrConf.InputDirectory: directory where all elastix inputs are transparently written</li><li>StrConf.OutputDirectory: directory where all elastix outputs are transparently read</li><li>StrConf.ElastixProgram: the name of elastix program</li><li>StrConf.TransformixProgram: the name of the transformix program</li><li>StrConf.ExampleInputDirectory: directory of the example provided by elastix. <b>The default value is '' and must be adjusted to run that example.</b></li></ul></div><p>You probably do not need to adjust the other fields which are filenames skeletons.</p><h2 id="3">Test elastix version</h2><pre class="codeinput">[Status, ErrorMessage] = elxTestElastixVersion(myConf);
<span class="keyword">if</span> ~Status
    error(ErrorMessage);
<span class="keyword">end</span>
</pre><h2 id="4">Test myConf.ExampleInputDirectory</h2><pre class="codeinput"><span class="keyword">if</span> strcmp(myConf.ExampleInputDirectory, <span class="string">''</span>)
  error([<span class="string">'Please set myConf.ExampleInputDirectory'</span> <span class="keyword">...</span>
    <span class="string">' in elxDefaultConfiguration.m to the full name of the exampleinput'</span> <span class="keyword">...</span>
    <span class="string">' elastix directory.  You can also or create your own '</span> <span class="keyword">...</span>
    <span class="string">' elxUserDefaultConfiguration.m function to set this field.'</span>]);
<span class="keyword">end</span>
</pre><h2 id="5">Load the fixed and moving image into Matlab</h2><p>Dim is the space dimension (usually 2 or 3). elxMetaIOFileToStrDatax reads an mhd file and return in Matlab an image structure.  The mhd format is the default format used by ElastixFromMatlab</p><pre class="codeinput">Dim = 2;
FixedImageFilename = fullfile(myConf.ExampleInputDirectory, <span class="string">'fixed.mhd'</span>);
MovingImageFilename = fullfile(myConf.ExampleInputDirectory, <span class="string">'moving.mhd'</span>);
<span class="keyword">if</span> ~exist(FixedImageFilename, <span class="string">'file'</span>) || ~exist(MovingImageFilename, <span class="string">'file'</span>)
  error([<span class="string">'The FixedImageFilename (%s) or MovingImageFilename (%s) do not exist.'</span> <span class="keyword">...</span>
    <span class="string">' Are you sure the dir_exampleinput directory(%s) point to the exampleinput'</span>, <span class="keyword">...</span>
    <span class="string">' directory of the Elastix example ?'</span>], FixedImageFilename, <span class="keyword">...</span>
    MovingImageFilename);
<span class="keyword">end</span>
FixedImage = elxMetaIOFileToStrDatax(FixedImageFilename);
MovingImage = elxMetaIOFileToStrDatax(MovingImageFilename);
</pre><p><tt>FixedImage</tt> and <tt>MovingImage</tt> have the folloxing fields:</p><div><ul><li>Data : the pixel values on a regular grid.</li><li>x : a cell of <tt>Dim</tt> vectors describing the position of the pixels along each dimension. So x{k} has size(Data, k) elements.  The x{k} are regularly increasing sequences.</li></ul></div><h2 id="7">Show the fixed and moving images</h2><pre class="codeinput">figure(1); colormap <span class="string">gray</span>
subplot(1, 2, 1);
</pre><p>Note that we have to flip the vectors x{k} when displaying images, because when Matlab displays an image the x-axis is along the rows, and y-axis along the columns.</p><pre class="codeinput">imagesc(FixedImage.x{[2 1]}, FixedImage.Data, [0 255]);
xlabel(<span class="string">'x\{2\}'</span>)
ylabel(<span class="string">'x\{1\}'</span>);
title(<span class="string">'Fixed image'</span>);
axis <span class="string">image</span>;
subplot(1, 2, 2);
imagesc(MovingImage.x{[2 1]}, MovingImage.Data, [0 255]);
title(<span class="string">'Moving image'</span>);
xlabel(<span class="string">'x\{2\}'</span>);
ylabel(<span class="string">'x\{1\}'</span>);
axis <span class="string">image</span>;
</pre><img vspace="5" hspace="5" src="elxExampleElastix_01.png" alt=""> <p>We perform a registration by doing sequentially:</p><div><ol><li>a rigid registration with the Euler Transform</li><li>a bspline registration</li></ol></div><p>So let us start definig those transforms.</p><h2 id="10">Configure the Euler transform</h2><p>First get a set of default values for the Euler Transform. Param is a cell array of structure because different transforms may need different fields.</p><pre class="codeinput">Param{1} = elxDefaultParameters(<span class="string">'EulerTransform'</span>, Dim);
</pre><p>Now, add or overwrite parameters.  To add a new parameter, add a field to the structure.  Beware of the field names which are not checked: If you misspell a parameter name, then elastix may use a default value for the intended parameter.</p><pre class="codeinput">Param{1}.FixedImagePyramid = <span class="string">'FixedRecursiveImagePyramid'</span>;
Param{1}.MovingImagePyramid = <span class="string">'MovingRecursiveImagePyramid'</span>;
Param{1}.Metric = <span class="string">'AdvancedMattesMutualInformation'</span>;
Param{1}.AutomaticScalesEstimation = true;
Param{1}.AutomaticTransformInitialization = true;
Param{1}.NumberOfHistogramBins = 32;
Param{1}.NumberOfResolutions = 4;
Param{1}.ImageSampler = <span class="string">'Random'</span>;
Param{1}.MaximumuNumberOfIterations = 250;
Param{1}.FinalBSplineInterpolationOrder = 3;
Param{1}.DefaultPixelValue = 0;
Param{1}.ResultImagePixelType = <span class="string">'short'</span>;
</pre><h2 id="12">Configure the BSpline transform</h2><pre class="codeinput">Param{2} = Param{1};
Param{2}.Transform = <span class="string">'BSplineTransform'</span>;
Param{2}.FinalGridSpacingInPhysicalUnits = 16;
</pre><h2 id="13">Run Elastix</h2><p>The following command</p><div><ul><li>writes the fixed and moving image in myConf.InputDirectory as well as the parameter configuration files.</li><li>constructs the elastix command line</li><li>runs elastix</li><li>loads the registered moving images into the struct array <tt>RegMoving</tt></li><li>load the transforms into a cell array of structures <tt>Transforms</tt></li><li>parses the logs and create a structure <tt>Log</tt></li><li>returns <tt>Succes</tt> a flag equals to one if elastix succeeded</li><li>returns <tt>ErrorMessage</tt> a cell of strings.</li></ul></div><pre class="codeinput">[RegMoving, Transforms, Log, Success, ErrorMessage] = elxElastix(myConf, <span class="keyword">...</span>
  Param, FixedImage, MovingImage);
</pre><pre class="codeoutput">Warning: Escaped character '\m' is not valid. See 'doc sprintf' for supported
special characters. 
Warning: Escaped character '\m' is not valid. See 'doc sprintf' for supported
special characters. 
Warning: Escaped character '\m' is not valid. See 'doc sprintf' for supported
special characters. 
Warning: Escaped character '\m' is not valid. See 'doc sprintf' for supported
special characters. 
</pre><p>Did elastix succeed?</p><pre class="codeinput"><span class="keyword">if</span> Success
  disp(<span class="string">'ok elastix succeeded.'</span>);
<span class="keyword">else</span>
  error(<span class="string">'elastix failed. This is embarassing.'</span>);
<span class="keyword">end</span>
</pre><pre class="codeoutput error">Error using elxExampleElastix (line 154)
elastix failed. This is embarassing.
</pre><h2 id="15">Display the registered images and the metrics at each resolution</h2><pre class="codeinput"><span class="keyword">for</span> cpt = 1:2
</pre><pre class="codeinput">  figure(1 + cpt); colormap <span class="string">gray</span>
  subplot(2, 1, 1);
  imagesc(RegMoving(cpt).x{[2 1]}, RegMoving(cpt).Data, [0 255]);
  title(Transforms{cpt}.Transform);
  <span class="keyword">if</span> cpt == 1
    disp(<span class="string">'Euler transform parameters:'</span>);
    Transforms{cpt}.TransformParameters
  <span class="keyword">else</span>
    disp(<span class="string">'The first 10 BSpline transform parameters'</span>)
    Transforms{cpt}.TransformParameters(1:10)
  <span class="keyword">end</span>
  axis <span class="string">image</span>;
  subplot(2, 1, 2);
  plot([Log.ParameterFile(cpt).Resolution(:).Metric])
  xlabel(<span class="string">'Iteration #'</span>);
  ylabel(<span class="string">'Metric'</span>);
  legend(<span class="string">'Resolution 0'</span>, <span class="string">'Resolution 1'</span>, <span class="string">'Resolution 2'</span>, <span class="string">'Resolution 3'</span>);
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><h2 id="18">Compare with the expected result</h2><p>To compare the two image, we construct a Mosaic image.</p><pre class="codeinput">SizeOfTiles = [16 16];
ExpSol = elxMetaIOFileToStrDatax(fullfile(myConf.ExampleInputDirectory, <span class="keyword">...</span>
  <span class="string">'solution_deformedmovingimage.mhd'</span>));
figure(4); colormap(gray);
MMask = elxMosaicImageMaskOfRectangles(size(RegMoving(2).Data), SizeOfTiles, [0 0]);
MImage = elxMosaicImage(MMask, RegMoving(2).Data, ExpSol.Data);
imagesc(RegMoving(2).x{[2 1]}, MImage, [0 256]);
axis <span class="string">image</span>;
xlabel(<span class="string">'x\{2\}'</span>);
ylabel(<span class="string">'x\{1\}'</span>);
title(<span class="string">'Mosaic of the computed and expected images'</span>);
</pre><h2 id="19">What about the <tt>Log</tt> structure?</h2><pre class="codeinput">Log.Command
</pre><h2 id="20">Elastix and masks</h2><p>In the following we mask the input images to prevent background pixels to be taken into account.  So first load the mask, and then add to elastix the fixed and moving image masks.</p><pre class="codeinput">FixedMask = elxMetaIOFileToStrDatax(fullfile(myConf.ExampleInputDirectory, <span class="keyword">...</span>
  <span class="string">'mask_fixed.mhd'</span>));
MovingMask = elxMetaIOFileToStrDatax(fullfile(myConf.ExampleInputDirectory, <span class="keyword">...</span>
  <span class="string">'mask_moving.mhd'</span>));
[RegMovingWithMask, Transforms, Log, Success, Message] = elxElastix(myConf, <span class="keyword">...</span>
  Param, FixedImage, MovingImage, <span class="string">'FixedMask'</span>, FixedMask, <span class="string">'MovingMask'</span>, MovingMask);
</pre><h2 id="21">Apply the deformation to the moving mask and compute the determinant of the jacobian</h2><p>After doing the registration, we could apply the found deformation to the moving mask. In that case, it would be necessary to change the FinalBSplineInterpolationOrder to 0 first (see Elastix manual) in the BSplineTransform.</p><pre class="codeinput">Transforms{2}.FinalBSplineInterpolationOrder = 0;
</pre><p>Transformix can also be used to generate a deformation field, or the determinant of the jacobian of the deformation field (which indicates the amount of compression/expansion.</p><pre class="codeinput">[TrxOut, Log, Success, Message] = elxTransformix(myConf, Transforms, <span class="keyword">...</span>
  <span class="string">'Image'</span>, MovingMask, <span class="string">'DeterminantOfSpatialJacobian'</span>, true);
</pre><p><tt>transformix</tt> is a rather versatile command that can return several outputs. So each field of <tt>TrxOut</tt> is one of those results.</p><pre class="codeinput">TMovingMask = TrxOut.TransformedImage;
DJacob = TrxOut.DeterminantOfSpatialJacobian;

figure(5); colormap(gray);
subplot(1, 2, 1);
imagesc(MovingMask.x{[2 1]}, MovingMask.Data);
axis <span class="string">image</span>;
title(<span class="string">'Moving mask'</span>);
subplot(1, 2, 2);
imagesc(TMovingMask.x{[2 1]}, TMovingMask.Data);
axis <span class="string">image</span>;
title(<span class="string">'Deformed moving mask'</span>);

figure(6); colormap(gray);
imagesc(DJacob.x{[2 1]}, DJacob.Data);
title(<span class="string">'Determinant of spatial Jacobian'</span>);
axis <span class="string">image</span>;
</pre><h2 id="24">License</h2><p>Copyright (C) CNRS and Riverside Research Contributors: Alain CORON, Jonathan MAMOU (2010)</p><p><a href="alain.coron@upmc.fr">alain.coron@upmc.fr</a>, <a href="JMamou@riversideresearch.org">JMamou@riversideresearch.org</a></p><p>This software is a computer program whose purpose is to effectively register images within Matlab (<a href="http://www.mathworks.com">http://www.mathworks.com</a>) with elastix (<a href="http://elastix.isi.uu.nl/">http://elastix.isi.uu.nl/</a>), an open-source image-registration software.</p><p>This software was supported in part by NIH Grant CA100183, the Riverside Research Biomedical Engineering Research Fund, and CNRS.</p><p>This software is governed by the CeCILL-B license under French law and abiding by the rules of distribution of free software.  You can  use, modify and/ or redistribute the software under the terms of the CeCILL-B license as circulated by CEA, CNRS and INRIA at the following URL "http://www.cecill.info".</p><p>As a counterpart to the access to the source code and  rights to copy, modify and redistribute granted by the license, users are provided only with a limited warranty  and the software's author,  the holder of the economic rights,  and the successive licensors  have only  limited liability.</p><p>In this respect, the user's attention is drawn to the risks associated with loading,  using,  modifying and/or developing or reproducing the software by the user in light of its specific status of free software, that may mean  that it is complicated to manipulate,  and  that  also therefore means  that it is reserved for developers  and  experienced professionals having in-depth computer knowledge. Users are therefore encouraged to load and test the software's suitability as regards their requirements in conditions enabling the security of their systems and/or data to be ensured and,  more generally, to use and operate it in the same conditions as regards security.</p><p>The fact that you are presently reading this means that you have had knowledge of the CeCILL-B license and that you accept its terms.</p><p>$Id: elxExampleElastix.m 2 2012-04-27 19:42:47Z coron $</p><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2017a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Elastix example in Matlab
%
% This Matlab script shows how to reproduce with ElastixFromMatlab the 
% Elastix example provided with the source code.
% Before running that script, you must
%
% * understand Elastix
% * be familiar with the Elastix example
% * be familiar with Matlab
% * have installed elastix on your computer and have successfully run the 
% function <elxTestDefaultConfiguration.html |elxTestDefaultConfiguration|>.
%


%% Load the ElastixFromMatlab configuration
myConf = elxDefaultConfiguration;

%%
% Feel free to adjust the settings in
%
% * <elxDefaultConfiguration.html |elxDefaultConfiguration|> which is the
% system wide default configuration file
% * elxUserDefaultConfiguraiont which is the user default configuration file 
% (If this last function exists and is in your path, it is called by 
% <elxDefaultConfiguration.html |elxDefaultConfiguration|>).
%
% In those files, you may adjust:
%
% * StrConf.InputDirectory: directory where all elastix inputs are transparently written
% * StrConf.OutputDirectory: directory where all elastix outputs are transparently read
% * StrConf.ElastixProgram: the name of elastix program
% * StrConf.TransformixProgram: the name of the transformix program
% * StrConf.ExampleInputDirectory: directory of the example provided by
% elastix. *The default value is '' and must be adjusted to run that
% example.*
%
% You probably do not need to adjust the other fields which are filenames
% skeletons.

%% Test elastix version
[Status, ErrorMessage] = elxTestElastixVersion(myConf);
if ~Status
    error(ErrorMessage);
end

%% Test myConf.ExampleInputDirectory
if strcmp(myConf.ExampleInputDirectory, '')
  error(['Please set myConf.ExampleInputDirectory' ...
    ' in elxDefaultConfiguration.m to the full name of the exampleinput' ...
    ' elastix directory.  You can also or create your own ' ...
    ' elxUserDefaultConfiguration.m function to set this field.']);
end
  

%% Load the fixed and moving image into Matlab
% Dim is the space dimension (usually 2 or 3).
% elxMetaIOFileToStrDatax reads an mhd file and return in Matlab an image
% structure.  The mhd format is the default format used by
% ElastixFromMatlab
Dim = 2;
FixedImageFilename = fullfile(myConf.ExampleInputDirectory, 'fixed.mhd');
MovingImageFilename = fullfile(myConf.ExampleInputDirectory, 'moving.mhd');
if ~exist(FixedImageFilename, 'file') || ~exist(MovingImageFilename, 'file')
  error(['The FixedImageFilename (%s) or MovingImageFilename (%s) do not exist.' ...
    ' Are you sure the dir_exampleinput directory(%s) point to the exampleinput', ...
    ' directory of the Elastix example ?'], FixedImageFilename, ...
    MovingImageFilename);
end
FixedImage = elxMetaIOFileToStrDatax(FixedImageFilename);
MovingImage = elxMetaIOFileToStrDatax(MovingImageFilename);
%%%
% |FixedImage| and |MovingImage| have the folloxing fields:
% 
% * Data : the pixel values on a regular grid.
% * x : a cell of |Dim| vectors describing the position of the pixels along
% each dimension. So x{k} has size(Data, k) elements.  The x{k} are
% regularly increasing sequences.
% 

%% Show the fixed and moving images
figure(1); colormap gray
subplot(1, 2, 1);
%%%
% Note that we have to flip the vectors x{k} when displaying images, because 
% when Matlab displays an image the x-axis is along the rows, and y-axis 
% along the columns.
imagesc(FixedImage.x{[2 1]}, FixedImage.Data, [0 255]);
xlabel('x\{2\}')
ylabel('x\{1\}');
title('Fixed image');
axis image;
subplot(1, 2, 2);
imagesc(MovingImage.x{[2 1]}, MovingImage.Data, [0 255]);
title('Moving image');
xlabel('x\{2\}');
ylabel('x\{1\}');
axis image;

%%
% We perform a registration by doing sequentially:
%
% # a rigid registration with the Euler Transform
% # a bspline registration
%
% So let us start definig those transforms.

%% Configure the Euler transform
% First get a set of default values for the Euler Transform. Param is a
% cell array of structure because different transforms may need different fields.
Param{1} = elxDefaultParameters('EulerTransform', Dim);
%%%
% Now, add or overwrite parameters.  To add a new parameter, add a field to 
% the structure.  Beware of the field names which are not checked: If you
% misspell a parameter name, then elastix may use a default value for the 
% intended parameter.
Param{1}.FixedImagePyramid = 'FixedRecursiveImagePyramid';
Param{1}.MovingImagePyramid = 'MovingRecursiveImagePyramid';
Param{1}.Metric = 'AdvancedMattesMutualInformation';
Param{1}.AutomaticScalesEstimation = true;
Param{1}.AutomaticTransformInitialization = true;
Param{1}.NumberOfHistogramBins = 32;
Param{1}.NumberOfResolutions = 4;
Param{1}.ImageSampler = 'Random';
Param{1}.MaximumuNumberOfIterations = 250;
Param{1}.FinalBSplineInterpolationOrder = 3;
Param{1}.DefaultPixelValue = 0;
Param{1}.ResultImagePixelType = 'short';

%% Configure the BSpline transform
Param{2} = Param{1};
Param{2}.Transform = 'BSplineTransform';
Param{2}.FinalGridSpacingInPhysicalUnits = 16;

%% Run Elastix
% The following command
% 
% * writes the fixed and moving image in myConf.InputDirectory as well as
% the parameter configuration files.
% * constructs the elastix command line
% * runs elastix
% * loads the registered moving images into the struct array |RegMoving|
% * load the transforms into a cell array of structures |Transforms|
% * parses the logs and create a structure |Log|
% * returns |Succes| a flag equals to one if elastix succeeded
% * returns |ErrorMessage| a cell of strings.
[RegMoving, Transforms, Log, Success, ErrorMessage] = elxElastix(myConf, ...
  Param, FixedImage, MovingImage);

%%
% Did elastix succeed?
if Success
  disp('ok elastix succeeded.');
else
  error('elastix failed. This is embarassing.');
end

%% Display the registered images and the metrics at each resolution
for cpt = 1:2
  %%
  figure(1 + cpt); colormap gray
  subplot(2, 1, 1);
  imagesc(RegMoving(cpt).x{[2 1]}, RegMoving(cpt).Data, [0 255]);
  title(Transforms{cpt}.Transform);
  if cpt == 1
    disp('Euler transform parameters:');
    Transforms{cpt}.TransformParameters
  else
    disp('The first 10 BSpline transform parameters')
    Transforms{cpt}.TransformParameters(1:10)
  end
  axis image;
  subplot(2, 1, 2);
  plot([Log.ParameterFile(cpt).Resolution(:).Metric])
  xlabel('Iteration #');
  ylabel('Metric');
  legend('Resolution 0', 'Resolution 1', 'Resolution 2', 'Resolution 3');
end

%% Compare with the expected result
% To compare the two image, we construct a Mosaic image.
SizeOfTiles = [16 16];
ExpSol = elxMetaIOFileToStrDatax(fullfile(myConf.ExampleInputDirectory, ...
  'solution_deformedmovingimage.mhd'));
figure(4); colormap(gray);
MMask = elxMosaicImageMaskOfRectangles(size(RegMoving(2).Data), SizeOfTiles, [0 0]);
MImage = elxMosaicImage(MMask, RegMoving(2).Data, ExpSol.Data);
imagesc(RegMoving(2).x{[2 1]}, MImage, [0 256]);
axis image;
xlabel('x\{2\}');
ylabel('x\{1\}');
title('Mosaic of the computed and expected images');

%% What about the |Log| structure?
Log.Command

%% Elastix and masks
% In the following we mask the input images to prevent background pixels 
% to be taken into account.  So first load the mask, and then add to
% elastix the fixed and moving image masks.
FixedMask = elxMetaIOFileToStrDatax(fullfile(myConf.ExampleInputDirectory, ...
  'mask_fixed.mhd'));
MovingMask = elxMetaIOFileToStrDatax(fullfile(myConf.ExampleInputDirectory, ...
  'mask_moving.mhd'));
[RegMovingWithMask, Transforms, Log, Success, Message] = elxElastix(myConf, ...
  Param, FixedImage, MovingImage, 'FixedMask', FixedMask, 'MovingMask', MovingMask);

%% Apply the deformation to the moving mask and compute the determinant of the jacobian
% After doing the registration, we could apply the found deformation
% to the moving mask. In that case, it would be necessary to change
% the FinalBSplineInterpolationOrder to 0 first (see Elastix manual) in the
% BSplineTransform.
Transforms{2}.FinalBSplineInterpolationOrder = 0;
%%
% Transformix can also be used to generate a deformation field,
% or the determinant of the jacobian of the deformation field (which 
% indicates the amount of compression/expansion.
[TrxOut, Log, Success, Message] = elxTransformix(myConf, Transforms, ...
  'Image', MovingMask, 'DeterminantOfSpatialJacobian', true);
%%
% |transformix| is a rather versatile command that can return several outputs.
% So each field of |TrxOut| is one of those results.
TMovingMask = TrxOut.TransformedImage;
DJacob = TrxOut.DeterminantOfSpatialJacobian;

figure(5); colormap(gray);
subplot(1, 2, 1);
imagesc(MovingMask.x{[2 1]}, MovingMask.Data);
axis image;
title('Moving mask');
subplot(1, 2, 2);
imagesc(TMovingMask.x{[2 1]}, TMovingMask.Data);
axis image;
title('Deformed moving mask');

figure(6); colormap(gray);
imagesc(DJacob.x{[2 1]}, DJacob.Data);
title('Determinant of spatial Jacobian');
axis image;

%% License
%
% Copyright (C) CNRS and Riverside Research 
% Contributors: Alain CORON, Jonathan MAMOU (2010)
% 
% <alain.coron@upmc.fr>, <JMamou@riversideresearch.org>
% 
% This software is a computer program whose purpose is to 
% effectively register images within Matlab (http://www.mathworks.com) 
% with elastix (http://elastix.isi.uu.nl/), an open-source image-registration
% software.
%
% This software was supported in part by NIH Grant CA100183, the Riverside 
% Research Biomedical Engineering Research Fund, and CNRS.
%
% This software is governed by the CeCILL-B license under French law and
% abiding by the rules of distribution of free software.  You can  use, 
% modify and/ or redistribute the software under the terms of the CeCILL-B
% license as circulated by CEA, CNRS and INRIA at the following URL
% "http://www.cecill.info". 
%
% As a counterpart to the access to the source code and  rights to copy,
% modify and redistribute granted by the license, users are provided only
% with a limited warranty  and the software's author,  the holder of the
% economic rights,  and the successive licensors  have only  limited
% liability. 
%
% In this respect, the user's attention is drawn to the risks associated
% with loading,  using,  modifying and/or developing or reproducing the
% software by the user in light of its specific status of free software,
% that may mean  that it is complicated to manipulate,  and  that  also
% therefore means  that it is reserved for developers  and  experienced
% professionals having in-depth computer knowledge. Users are therefore
% encouraged to load and test the software's suitability as regards their
% requirements in conditions enabling the security of their systems and/or 
% data to be ensured and,  more generally, to use and operate it in the 
% same conditions as regards security. 
% 
% The fact that you are presently reading this means that you have had
% knowledge of the CeCILL-B license and that you accept its terms.

%%
% $Id: elxExampleElastix.m 2 2012-04-27 19:42:47Z coron $

##### SOURCE END #####
--></body></html>